name: publish.yml

on:
  workflow_dispatch: 
    inputs:
      PushToProd:
        description: 'Push to production nuget'
        required: false
        default: false
        type: boolean
      UseRemoteSpec:
        description: 'Download the infisical spec from their website or stand up a container for local download'
        required: false
        default: true
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'
      
      - name: 'Cache: nuget'
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: ${{ runner.os }}-${{ hashFiles('**/global.json', '**/*.csproj', '**/Directory.Packages.props') }}
      
      - name: 'Download aspire' # TODO remove this step when aspire fixes the workload bugs
        run: dotnet workload restore
      
      - name: 'Publish'
        run: dotnet run --project ./Pipeline/Pipeline.csproj
        env:
          Nuget__PushToProd: ${{ inputs.PushToProd }}
          Nuget__ApiKey: ${{ inputs.PushToProd == 'true' && secrets.NugetApiKey || secrets.IntNugetApiKey }}
          DownloadInfisicalSpec__UseRemoteServer: ${{ inputs.UseRemoteSpec }}