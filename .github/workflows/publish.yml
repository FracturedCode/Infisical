name: publish.yml

on:
  workflow_dispatch: 
    inputs:
      PushToProd:
        description: 'Push to production nuget'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: setup-docker
        uses: docker-practice/actions-setup-docker@v1
        with:
          docker_version: '27.1.1'
      
      - name: 'Cache: nuget'
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: ${{ runner.os }}-${{ hashFiles('**/global.json', '**/*.csproj', '**/Directory.Packages.props') }}
      
      - name: 'Download aspire' # TODO remove this step when aspire fixes the workload bugs
        run: dotnet workload restore
      
      - name: 'Publish'
        run: dotnet run --project ./Pipeline/Pipeline.csproj
        env:
          Nuget__PushToProd: ${{ inputs.PushToProd }}
          Nuget__ApiKey: ${{ inputs.PushToProd == 'true' && secrets.NugetApiKey || secrets.IntNugetApiKey }}